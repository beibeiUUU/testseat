<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>考試隨機排座 (7人一桌)</title>
  <style>
    :root {
      --bg: #f7f6f2;
      --ink: #10212b;
      --muted: #5b6b73;
      --accent: #d45d5d;
      --line: #d9d4cc;
      --card: #ffffff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      font-family: "Trebuchet MS", "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 20%, #fdf3f0, #f7f6f2 45%, #f2f0eb 100%);
      color: var(--ink);
    }
    h1 { margin: 0 0 12px; letter-spacing: 0.5px; }
    .muted { color: var(--muted); font-size: 14px; }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }
    .control {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 14px;
    }
    label span { color: var(--muted); font-size: 12px; }
    input[type="number"] {
      width: 120px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 8px;
      font-size: 14px;
    }
    button {
      padding: 10px 14px;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #fff;
      border-radius: 10px;
      font-weight: 700;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.12s ease;
      box-shadow: 0 6px 12px rgba(212, 93, 93, 0.25);
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); box-shadow: 0 3px 6px rgba(0,0,0,0.12); }
    .status {
      margin-top: 6px;
      font-size: 14px;
      color: var(--muted);
    }
    .tables {
      display: grid;
      grid-template-columns: repeat(2, minmax(280px, 1fr));
      gap: 12px;
      margin-top: 16px;
      align-items: start;
    }
    .table-card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 12px 22px rgba(16, 33, 43, 0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .table-title {
      font-weight: 800;
      letter-spacing: 0.5px;
    }
    .wide {
      grid-column: 1 / span 2;
      max-width: 640px;
      width: 100%;
      justify-self: center;
    }
    .table-visual {
      border: 2px solid var(--line);
      border-radius: 12px;
      padding: 6px 8px;
      background: linear-gradient(135deg, #fff, #f7f5f3);
    }
    .seat-row {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 6px;
      margin-bottom: 4px;
    }
    .seat-slot {
      text-align: center;
    }
    .seat-circle {
      width: 38px;
      height: 38px;
      margin: 0 auto 4px;
      border-radius: 50%;
      border: 2px solid var(--ink);
      display: grid;
      place-items: center;
      font-weight: 700;
      background: #fdf9f9;
    }
    .seat-name {
      font-size: 18px;
      line-height: 1.3;
      color: var(--muted);
      word-break: break-all;
    }
    .blackboard {
      margin: 10px auto 12px;
      width: 240px;
      text-align: center;
      padding: 12px 10px;
      border: 3px solid var(--ink);
      border-radius: 12px;
      font-weight: 800;
      letter-spacing: 1px;
      background: #f0ede7;
    }
    @media (max-width: 820px) {
      body { padding: 16px; }
      .tables { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
      .seat-row { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .wide { grid-column: auto; }
    }
  </style>
</head>
<body>
  <header>
    <h1>考試隨機排座 (7人一桌)</h1>
    <div class="muted">載入 logic.txt 後按下「重新洗牌」即可。會自動增加桌數以容納所有學生。</div>
  </header>

  <section class="controls">
    <div class="control">
      <label>學生名單檔案 (UTF-8) <span>格式: 學號 空白/Tab 姓名</span></label>
      <input type="file" id="file" accept=".txt">
    </div>
    <div class="control">
      <label>想要的桌數 <span>每桌 7 人，可留空自動計算</span></label>
      <input type="number" id="tableCount" min="1" placeholder="自動">
    </div>
    <div class="control">
      <label>&nbsp;</label>
      <button id="shuffle">重新洗牌</button>
    </div>
  </section>
  <div class="status" id="status">讀取中…</div>

  <div class="blackboard">BLACKBOARD</div>

  <section class="tables" id="tables"></section>

  <script>
    const seatsPerTable = 7;
    const statusEl = document.getElementById("status");
    const tablesEl = document.getElementById("tables");
    const fileInput = document.getElementById("file");
    const tableCountInput = document.getElementById("tableCount");
    const shuffleBtn = document.getElementById("shuffle");

    let students = [];

    function parseStudents(text) {
      return text
        .split(/\r?\n/)
        .map((line) => line.trim())
        .filter(Boolean)
        .map((line) => {
          const parts = line.split(/\s+/);
          if (parts.length >= 2) return parts.slice(1).join(""); // 顯示姓名
          return parts[0];
        });
    }

    function shuffle(list) {
      const arr = [...list];
      for (let i = arr.length - 1; i > 0; i -= 1) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function render() {
      if (!students.length) {
        statusEl.textContent = "尚未載入名單。";
        tablesEl.innerHTML = "";
        return;
      }

      const requested = Number(tableCountInput.value);
      const autoTables = Math.ceil(students.length / seatsPerTable) || 1;
      const tableCount = Number.isFinite(requested) && requested > 0 ? Math.max(requested, autoTables) : autoTables;
      const capacity = tableCount * seatsPerTable;
      const shuffled = shuffle(students);

      const tables = Array.from({ length: tableCount }, () => []);
      shuffled.forEach((student, idx) => {
        const t = Math.floor(idx / seatsPerTable);
        if (t < tableCount) tables[t].push({ seat: (idx % seatsPerTable) + 1, student });
      });

      statusEl.textContent = `學生數：${students.length}；桌數：${tableCount} (容量 ${capacity} 人)`;

      tablesEl.innerHTML = tables
        .map((seats, idx) => {
          const seatRow = Array.from({ length: seatsPerTable }, (_, i) => {
            const data = seats[i];
            const label = i + 1;
            const name = data ? data.student : "";
            return `
              <div class="seat-slot">
                <div class="seat-circle">${label}</div>
                <div class="seat-name">${name || "&nbsp;"}</div>
              </div>
            `;
          }).join("");

          // 若最後剩一張桌，置中佔滿一列，排版類似「兩桌一排，最後單桌置中」。
          const isLastAlone = tables.length % 2 === 1 && idx === tables.length - 1;
          const wideClass = isLastAlone ? "wide" : "";

          return `
            <article class="table-card ${wideClass}">
              <div class="table-title">Table ${idx + 1}</div>
              <div class="table-visual">
                <div class="seat-row">${seatRow}</div>
              </div>
            </article>
          `;
        })
        .join("");
    }

    fileInput.addEventListener("change", () => {
      const file = fileInput.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        students = parseStudents(String(e.target?.result || ""));
        statusEl.textContent = `已載入 ${students.length} 位學生，點「重新洗牌」。`;
        render();
      };
      reader.readAsText(file, "utf-8");
    });

    shuffleBtn.addEventListener("click", render);

    async function tryLoadDefault() {
      try {
        const res = await fetch("logic.txt");
        if (!res.ok) throw new Error("fetch failed");
        const txt = await res.text();
        students = parseStudents(txt);
        statusEl.textContent = `已自動載入 logic.txt，共 ${students.length} 位。`;
        render();
      } catch (err) {
        students = ["Alice", "Bob", "Charlie", "Dana", "Eli", "Fatima", "Gina"];
        statusEl.textContent = "找不到 logic.txt，使用示範名單。";
        render();
      }
    }

    tryLoadDefault();
  </script>
</body>
</html>
